pipeline {
    agent any

    options {
        timestamps()
    }

    environment {
        // é•œåƒä»“åº“é…ç½®
        REGISTRY = '47.120.49.65:5001'
        IMAGE_NAME = 'micro-svc/test-golang-helloworld'
        APP_NAME = 'test-golang-helloworld'
        // ç‰ˆæœ¬é…ç½® - å¯é€šè¿‡å‚æ•°è¦†ç›–
        VERSION = "${params.VERSION ?: 'latest'}"
        NAMESPACE = 'xyz-dev'
        K8S_DEPLOYMENT_FILE_ID = 'deployment-template-go'

        // GitLab ç§ä»“åŸŸå
        GITLAB_HOST = 'lab.pistonint.com'
        K8S_CONFIG = credentials('jenkins-k8s-config')
    }

    stages {
        stage('Go Build') {
            agent {
                docker {
                    image 'golang:1.25'
                    args '-u root:root'
                    reuseNode true
                }
            }
            steps {
                echo 'å¼€å§‹ Go æ„å»º...'
                checkout scm
                script {
                    env.GIT_SHA = sh(returnStdout: true, script: 'git rev-parse --short=8 HEAD').trim()
                    echo "å½“å‰æäº¤: ${env.GIT_SHA}"
                }
                withCredentials([usernamePassword(
                        credentialsId: 'gitlab-secret',
                        usernameVariable: 'GIT_USERNAME',
                        passwordVariable: 'GIT_PASSWORD')]
                ) {
                    sh label: 'Go build in container', script: '''
                        set -eux
                        go version
                        
                        # é¦–å…ˆé…ç½® Go ç¯å¢ƒå˜é‡ï¼Œé¿å…è®¿é—® proxy.golang.org
                        go env -w GOPROXY=https://goproxy.cn,https://mirrors.aliyun.com/goproxy,direct
                        go env -w GOSUMDB=off
                        go env -w GOOS=linux 
                        go env -w GOARCH=arm64 
                        go env -w CGO_ENABLED=0 
                        go env -w GOPRIVATE=$GITLAB_HOST/* 
                        go env -w GONOSUMDB=$GITLAB_HOST/*
                        
                        # ç„¶åé…ç½® Git ç§ä»“å‡­æ®
                        git config --global url."https://${GIT_USERNAME}:${GIT_PASSWORD}@${GITLAB_HOST}/".insteadOf "https://${GITLAB_HOST}/"

                        # éªŒè¯ Go ç¯å¢ƒé…ç½®
                        echo "=== Go ç¯å¢ƒé…ç½® ==="
                        go env GOPROXY GOSUMDB GOPRIVATE GONOSUMDB
                        echo "=================="

                        # æ‹‰å–ä¾èµ–å¹¶æ„å»ºï¼ˆæ ¡éªŒå¯ç¼–è¯‘ï¼‰
                        # è®¾ç½®è¶…æ—¶å’Œé‡è¯•ï¼Œé¿å…ç½‘ç»œé—®é¢˜
                        timeout 300s bash -c '
                            for i in {1..3}; do
                                echo "å°è¯•ä¸‹è½½ä¾èµ– (ç¬¬ $i æ¬¡)..."
                                if go mod download; then
                                    echo "ä¾èµ–ä¸‹è½½æˆåŠŸï¼"
                                    break
                                else
                                    echo "ä¾èµ–ä¸‹è½½å¤±è´¥ (ç¬¬ $i æ¬¡)"
                                    if [ $i -eq 3 ]; then
                                        echo "æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥äº†"
                                        exit 1
                                    fi
                                    sleep 10
                                fi
                            done
                        '
                        
                        go build -ldflags="-w -s" -o helloworld-server main.go
                        
                        ls -la

                        # æ¸…ç† git ä¸´æ—¶å‡­æ®æ˜ å°„ï¼ˆé¿å…åç»­æ³„éœ²ï¼‰
                        git config --global --unset-all url."https://$GIT_USERNAME:$GIT_PASSWORD@$GITLAB_HOST/".insteadOf || true
                    '''
                }
            }
        }

        stage('Docker Build') {
            steps {
                echo 'å¼€å§‹æ„å»ºDockeré•œåƒå¤šå¹³å°æ„å»ºï¼Œç„¶åé•œåƒæ¨é€åˆ°é•œåƒæ³¨å†Œä¸­å¿ƒ...'
                script {
                    withCredentials([usernamePassword(
                            credentialsId: 'docker-registry-secret',
                            usernameVariable: 'GIT_USERNAME',
                            passwordVariable: 'GIT_PASSWORD')]
                    ) {
                        sh label: 'Docker build with GitLab credentials', script: '''
                            set -eux
                            # å¯ç”¨ BuildKit
                            export DOCKER_BUILDKIT=1
                            
                            # æ£€æŸ¥ buildx æ˜¯å¦å¯ç”¨
                            if docker buildx version >/dev/null 2>&1 && docker buildx inspect jenkins-builder >/dev/null 2>&1; then
                                echo "âœ… ä½¿ç”¨ buildx æ„å»ºé•œåƒ..."
                                docker buildx build \
                                  --platform linux/arm64/v8,linux/amd64 \
                                  --tag $REGISTRY/$IMAGE_NAME:$VERSION \
                                  --build-arg PLATFORM=linux/arm64/v8 \
                                  --push \
                                  .
                            else
                                echo "âš ï¸ buildx ä¸å¯ç”¨ï¼Œä½¿ç”¨ä¼ ç»Ÿæ„å»ºæ–¹å¼..."
                                docker build \
                                  -t $REGISTRY/$IMAGE_NAME:$VERSION \
                                  .
                            fi
                        '''
                    }
                }
            }
        }

        stage('k8så‘å¸ƒ') {
            agent {
                docker {
                    image 'bitnami/kubectl:latest'
                    args '-u root:root --entrypoint ""'
                }
            }
            steps {
                withKubeConfig([credentialsId: "jenkins-k8s-config",
                                serverUrl    : "https://kubernetes.default.svc.cluster.local"]) {
                    // ä½¿ç”¨ configFile æ’ä»¶ï¼Œåˆ›å»º Kubernetes éƒ¨ç½²æ–‡ä»¶ deployment.yaml
                    configFileProvider([configFile(
                            fileId: "${K8S_DEPLOYMENT_FILE_ID}",
                            targetLocation: "deployment.tpl")
                    ]) {
                        script {
                            sh "cat deployment.tpl"
                            def deployTemplate = readFile(encoding: "UTF-8", file: "deployment.tpl")
                            def deployment = deployTemplate
                                    .replace("{APP_NAME}", "${APP_NAME}")
                                    .replace("{NAMESPACE}", "${NAMESPACE}")
                                    .replace("{REGISTRY}", "${REGISTRY}")
                                    .replace("{IMAGE_NAME}", "${IMAGE_NAME}")
                                    .replace("{VERSION}", "${VERSION}")
                            writeFile(encoding: 'UTF-8', file: './deploy.yaml', text: "${deployment}")
                        }

                        // è¾“å‡ºæ–°åˆ›å»ºçš„éƒ¨ç½² yaml æ–‡ä»¶å†…å®¹
                        sh "cat deploy.yaml"
                        // æ‰§è¡Œ Kuberctl å‘½ä»¤è¿›è¡Œéƒ¨ç½²æ“ä½œ
                        // sh "kubectl apply -n ${NAMESPACE} -f deploy.yaml"
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'æ„å»ºç»“æŸ......'
            sh 'docker image ls | head -n 20 | cat'
        }
        success {
            script {
                echo "æ„å»ºå®Œæˆï¼Œé•œåƒåœ°å€: $REGISTRY/$IMAGE_NAME:$VERSION"
                cleanWs()
                echo 'âœ… æ„å»ºæˆåŠŸï¼'
                echo "ğŸ“¦ é•œåƒå·²æ¨é€åˆ°: $REGISTRY/$IMAGE_NAME:$VERSION"
            }
        }
        failure {
            echo 'âŒ æ„å»ºå¤±è´¥ï¼'
        }
        aborted {
            echo 'âš ï¸ æ„å»ºè¢«ä¸­æ­¢'
        }
    }
}
